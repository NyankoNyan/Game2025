# Формат конфигов утилиты BuildingGen

Этот формат предназначен для хранения описания зданий, их компонент, физического поведения и прочего. Также может содержать всякие кастомные параметры.

## Версия

Здесь описан формат версии 0.3.

## Базовые типы

### Атомарное число

Записывается как
```yaml
var_name: 
    value: 999.9
```

Или же в упрощённом варианте как
```yaml
var_name: 999.9
```

### Строка или идентификатор

```yaml
var_name:
    value: "Some string"
```

Также можно записать в упрощенном виде
```yaml
var_name: Some string
```

### Ссылка

```yaml
var_name:
    ref: other_var
```

В упрощенном варианте
```yaml
var_name: $other_var
```

Здесь видно, что упрощенная запись ссылки выглядит также как упрощенная запись строки, за исключением того, что перед ссылкой всегда должен стоять символ ```$```. При парсинге приоритет отдаётся ссылке. Поэтому если необходимо начать строку с символа ```$```, надо использовать полную запись строки ```var_name.value```.

### Формула

```yaml
var_name:
    node:
        operation: "+"
        nodes:
            - ref: other_var
            - value: 1
```

Для записи составных формул используется такой подход:
```yaml
var_name:
    node:
        operation: "*"
        nodes:
            - ref: mult_var
            - node:
                operation: "+"
                nodes:
                    - ref: add_var_1
                    - ref: add_var_2
```

Поскольку представленная схема, хоть и отображает итоговую структуру объектов, на практике представляется довольно неудобной, предлагается использовать упрощенную запись.

```yaml
var_name:
    mult:
        - $mult_var
        - add:
            - $add_var_1
            - $add_var_2
```

Поддерживаются следующие математические операции:

| Операция                    | Запись в operation | Упрощенная запись |
|-----------------------------|--------------------|-------------------|
| Сложение                    | +                  | add               |
| Вычитание                   | -                  | sub               |
| Умножение                   | *                  | mult              |
| Деление                     | /                  | div               |
| Возведение в степено        | **                 | pow               |
| Деление нацело              | //                 | intdiv            |
| Остаток от деления          | %                  | mod               |
| Инверсия                    | --                 | neg               |
| Округление с отбросом дроби | int                | int               |
| Битовый сдвиг вправо        | >>                 | rshift            |
| Битовый сдвиг влево         | <<                 | lshift            |
| Битовая инверсия            | ~                  | bitnot            |
| Битовое И                   | &                  | bitand            |
| Битовое ИЛИ                 | \|                 | bitor             |
| Битовое исключающее ИЛИ     | ^                  | bitxor            |

Если опeрация поддерживает два, то в неё можно добавить и больше операндов. Третий и последующие операнды будут применены к результату предыдущих операндов.

Если операции требует целочисленного аргумента, а аргумент дробный, он автоматически преобразуется по правилам `(int)N` языка C#.

### Случайные значения

Случайные значения представлены двумя формами записи, для целочисленных и для дробных значений. Рандомизация происходит по правилам Unity. Для целых это диапазон [x; y], для дробных [x; y).

```yaml
var_name:
    rand_int:
        - value: 1
        - value: 10

var_name:
    rand_float:
        - value: 1.5
        - value: 10.3
```

Есть упрощенная форма записи.

```yaml
var_name:
    - 1
    - 10

var_name: [1, 10]

var_name: [1.5, 10.3]
```

## Сложные типы

### Векторы

Векторы тождественны типу Unity `Vector3`. 

Вот такая запись означает `Vector3(1, 1, 1)` или же `Vector3.one`:
```yaml
var_name:
    vec3:
        x:
            value: 1
        y:
            value: 1
        z:
            value: 1
```

По умолчанию все компоненты вестора равны 0.

Эта запись тождественна Vector3(0, 1, 0):
```yaml
var_name:
    vec3:
        y:
            value: 1
```

Также есть отдельная запись для Vector3Int
```yaml
var_name:
    vec3i:
        x:
            value: 1
        y:
            value: 1
        z:
            value: 1
```

Есть два способа упростить запись вектора.

Если в переменной есть хоть одна из компонент x, y или z, то переменная считается вектором Vector3. Если все компоненты целочисленные, то считается целым вектором Vector3Int.
```yaml
var_name:
    x: 1
    y: 1
    z: $other_var
```

С другой стороны, все массивы размерностью 3 также считаются векторами по умолчанию
```yaml
var_name: [1.0, 1.0, $other_var]

var_name: [1, 1, {int: $other_var}] # Здесь int испольуется, чтобы получить Vector3Int.
```

## Структура документов

### Условные обозначение простых типов
| Запись | Что означает |
|-|-|
| VALUE | Любое числовое значение |
| CONST_VALUE | Числовое значение без возможности указать формулу или ссылку |
| INT | Целое значение |
| CONST_INT | Целое значение без формул и ссылок |
| STRING | Строковое значение |
| FIXED_STRING | Строковое значение без ссылок и формул |
| BOOL | Значение истина/ложь |
| VEC | Вектор |
| VEC_INT | Целочисленный вектор |
| MAP | Словарь значений |
| LIST | Список значений |

### Верхнеуровневая структура (BUILDING_CONFIG)
```yaml
version: FIXED_STRING
parameters: MAP of VALUE
blockGroups: LIST of BLOCK_GROUP
buildings: LIST of BUILDING
```

```yaml
version: "0.3"
parameters:
    var_1: VALUE
    var_2: VALUE
    ...
    var_N: VALUE
blockGroups:
    - BLOCK_GROUP
    - BLOCK_GROUP
    ...
    - BLOCK_GROUP
buildings:
    - BUILDING
    - BUILDING
    ...
    - BUILDING
```

### Группа блоков (BLOCK_GROUP)

Группа блоков - это по сути маппинг на визуальное представление блоков.

```yaml
id: FIXED_STRING
blocks:
    - BLOCK_GR_ENT
    - BLOCK_GR_ENT
    ...
    - BLOCK_GR_ENT
```

Пример
```yaml
id: "layer1"
blocks:
    -   name: "b2_f"
        pointType: "Inside"
    -   name: "b2_bc1"
        pointType: "Corner"
    -   name: "b2_bw1"
        pointType: "Boundary"
```

### Описание блока внутри группы (BLOCK_GR_ENT)
```yaml
name: FIXED_STRING
pointType: ENUM_POINT_TYPE
destroyed: BOOL
```

#### Параметр destroyed
По умолчанию false.

Обозначает уничтоженный блок здания.

Уничтоженный блок появляется на месте обычного и зависит от **оставшихся рядом неуничтоженных блоков**. Этот блок должен быть перестроен при уничтожении соседнего блока.

### Точка генераци блока (ENUM_POINT_TYPE)

При генерации блоков зданий могут учитываться разные параметры. Разные генераторы могут давать на выходе совершенно различные структуры данных. 

#### Тип позиций блоков для генератора типа Grid

Для этого генератора тип позиции может расчитываться исходя из 4-х соседних блоков

| Обозначение | Описание |
|-------------|----------|
| Inside      | Блок расположен внутри здания и окружен со всех сторон другими блоками |
| Boundary    | Внешняя стена здания, с трех боков которой другие стены |
| Corner      | Внешний угол здания |
| Peninsula   | Вынос стены из здания |
| Wall        | Стена, у которой соседние стены только с двух сторон |
| Island      | Блок, у которого нет соседних блоков |

### Описание здания (BUILDING)

```yaml
id: FIXED_STRING
name: FIXED_STRING
description: FIXED_STRING
parameters:
    var_1: VALUE
    var_2: VALUE
    ...
    var_N: VALUE
sections:
    - SECTION
    - SECTION
    ...
    - SECTION
```

### Секция здания (SECTION)

```yaml
id: FIXED_STRING
description: FIXED_STRING
blockGroupId: FIXED_STRING
position: VEC
rotation: VEC
parameters:
    var_1: VALUE
    var_2: VALUE
    ...
    var_N: VALUE
ENUM_GENERATION_TYPE: GENERATION_TYPE_SETTINGS
```

| Имя параметра | Описание |
|-|-|
| id | Идентификатор секции |
| blockGroupId | Используемая группа блоков |
| position | Позиция/смещение секции относительно нулевой точки здания |
| parameters | Переменные |
| ENUM_GENERATION_TYPE | Вместо этого параметра надо подставить конкретную настройку генерации |

#### Типы генерации (ENUM_GENERATION_TYPE)

| Имя параметра | Описание |
|-|-|
| generationSettingsGrid | Генерация в виде простой сетки |

### Параметры генерации простой сетки (GENERATION_TYPE_SETTINGS для generationSettingsGrid)

```yaml
generationSettingsGrid:
    size: VEC_INT
    spacing: VEC
```

| Имя параметра | Описание |
|-|-|
| size | Размер, сколько на сколько блоков |
| spacing | Расстояние между блоками |
